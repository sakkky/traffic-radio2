<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京23区 交通量音声サービス（JARTIC + Cloudflareプロキシ）</title>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background: #f0f0f0; 
            text-align: center; 
        }
        button { 
            padding: 15px 30px; 
            font-size: 20px; 
            margin: 15px; 
            cursor: pointer; 
            border-radius: 8px; 
        }
        #status { 
            margin-top: 30px; 
            font-size: 18px; 
            color: #333; 
            white-space: pre-wrap; 
            line-height: 1.5; 
        }
    </style>
</head>
<body>
    <h1>東京23区 交通量情報 音声</h1>
    <p>23区内の国道交通量を5分更新でチェック（Cloudflareプロキシ使用）</p>
    <button id="start">開始（音声ループ）</button>
    <button id="stop">停止</button>
    <div id="status">待機中...（開始ボタンを押してください）</div>

    <script>
        const STATUS = document.getElementById('status');
        const synth = window.speechSynthesis;
        let isSpeaking = false;

        // Cloudflare WorkersのプロキシURL（あなたのものに変更済み）
        const proxyBase = 'https://jartic-cors-proxy.sakkitotaki.workers.dev/';

        async function getTrafficText() {
            try {
                // 東京23区向け BBOX（緯度経度範囲）
                const originalUrl = `https://api.jartic-open-traffic.org/geoserver/wfs?` +
                                   `service=WFS&version=2.0.0&request=GetFeature&` +
                                   `typeNames=t_travospublic_measure_5m&` +
                                   `outputFormat=application/json&` +
                                   `srsName=EPSG:4326&` +
                                   `cql_filter=道路種別='3' AND ` +
                                   `BBOX(geom,139.45,35.55,139.93,35.82,'EPSG:4326')`;

                // プロキシ経由でリクエスト（CORS回避）
                const fetchUrl = `${proxyBase}?url=${encodeURIComponent(originalUrl)}`;

                const response = await fetch(fetchUrl);

                if (!response.ok) {
                    throw new Error(`HTTPエラー: ${response.status}`);
                }

                const data = await response.json();

                if (!data.features || data.features.length === 0) {
                    return 'データ取得失敗：23区内の観測地点が見つかりませんでした（時間帯による可能性あり）';
                }

                // 交通量の平均計算（有効なデータのみ）
                let totalVolume = 0;
                let count = 0;
                data.features.forEach(f => {
                    const vol = f.properties['交通量'] || 0;  // プロパティ名は公式仕様書確認推奨
                    if (vol > 0) {
                        totalVolume += vol;
                        count++;
                    }
                });

                const avgVolume = count > 0 ? Math.round(totalVolume / count) : 0;
                let text = `東京23区内の国道交通量（平均）：${avgVolume}台/5分間。`;

                // 簡易渋滞判定（基準は目安・調整自由）
                if (avgVolume < 400) {
                    text += ' 交通量がかなり少なく、渋滞が発生している可能性が高いです。注意運転を！';
                } else if (avgVolume < 800) {
                    text